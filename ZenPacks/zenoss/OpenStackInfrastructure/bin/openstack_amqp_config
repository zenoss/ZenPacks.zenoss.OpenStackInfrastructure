#!/bin/bash

echo $0

echo "RabbitMQ Configuration"
echo "--------------------"
echo "If using Europa, you *MUST* use this command in a rabbitmq container"

AMQP_USERID="openstack"
AMQP_PASSWORD="[previously configured password]"
AMQP_HOSTNAME=`zenglobalconf -p amqphost`
AMQP_PORT=`zenglobalconf -p amqpport`
AMQP_VIRTUAL_HOST=`zenglobalconf -p amqpvhost`
DEFAULT_IP=$(ip route get 8.8.8.8 | head -1 | cut -d' ' -f8)

# If in Europa, get first IP from CONTROLPLANE_HOST_IPS, otherwise default
if [ -z "$CONTROLPLANE_HOST_IPS" ]; then
   AMQP_HOSTNAME=$(zenglobalconf -p amqphost)
else
   AMQP_HOSTNAME=$(sed "s/\s.*$// ; s/'//g" <<< $CONTROLPLANE_HOST_IPS )
fi

sudo rabbitmqctl list_users | grep $AMQP_USERID > /dev/null
if [ "$?" = "0" ]; then
   echo "User '$AMQP_USERID' already exists in rabbitmq.  Leaving existing password in place."
   echo "If you need to change the password, use the following command:"
   echo "   sudo rabbitmqctl change_password $AMQP_USERID [newpassword]"
   echo ""
else
   AMQP_PASSWORD=`openssl rand -base64 15`

   echo "Adding user '$AMQP_USERID' user to rabbitmq"
   sudo rabbitmqctl add_user "$AMQP_USERID" "$AMQP_PASSWORD"
fi

# Ensure that openstack user has appropriate permissions
sudo rabbitmqctl clear_permissions -p "$AMQP_VIRTUAL_HOST" "$AMQP_USERID"
sudo rabbitmqctl set_permissions -p "$AMQP_VIRTUAL_HOST" "$AMQP_USERID" 'zenoss.openstack.*' 'zenoss.openstack.*' '^$'



CURRENTDIR="$(dirname "$(which "$0")")"
PARENTDIR=$(dirname $CURRENTDIR)

# Create any required exchanges
#$PARENTDIR/openstack_amqp_init.py

echo ""
echo "OpenStack Configuration"
echo "-----------------------"
echo "Add the following configuration to ceilometer.conf on all openstack nodes:"
echo ""
echo "    [DEFAULT]"
echo "    dispatcher=zenoss"
echo "" 
echo "    [notification]"
echo "    store_events=True"
echo ""
echo "    [dispatcher_zenoss]"
echo "    "
echo "    zenoss_device = [device that the openstack environment is registered as in zenoss]"
echo "    "
echo "    amqp_port = $AMQP_PORT"
echo "    amqp_userid = $AMQP_USERID"
echo "    amqp_password = $AMQP_PASSWORD"
echo "    amqp_virtual_host = $AMQP_VIRTUAL_HOST"
echo "    amqp_hostname = [The correct AMQP system IP or hostname (see below)]"
echo "    "
echo " ----------------------------------------------------------------"
echo " Note: Setting a Correct amqp_hostname in OpenStack Ceilometer"
echo " ----------------------------------------------------------------"
echo " * Your current Zenoss amqp_hostname is set to '$AMQP_HOSTNAME'."
echo ""
echo "  => If this differs from your default interface, $DEFAULT_IP, must find the"
echo "     appropriate entry for your amqp_hostname in ceilometer.conf."
echo "     It must be an accessible interface from your OpenStack system,"
echo "     and that interface must be one that accepts AMQP connections for "
echo "     your Zenoss installation."

# Export all the credentials to a separate file at /home/zenoss
touch /home/zenoss/openstack_amqp
echo "export ZENOSS_DEVICE=OpenStack" >> /home/zenoss/openstack_amqp
echo "export AMQP_USERID=$AMQP_USERID" >> /home/zenoss/openstack_amqp
echo "export AMQP_PASSWORD=$AMQP_PASSWORD" >> /home/zenoss/openstack_amqp
echo "export AMQP_PORT=$AMQP_PORT" >> /home/zenoss/openstack_amqp
echo "export AMQP_VIRTUAL_HOST=$AMQP_VIRTUAL_HOST" >> /home/zenoss/openstack_amqp
echo "export AMQP_HOSTNAME=$DEFAULT_IP" >> /home/zenoss/openstack_amqp

